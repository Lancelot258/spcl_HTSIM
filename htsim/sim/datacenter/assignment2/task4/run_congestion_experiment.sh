#!/bin/bash

# Congestion Scenario Experiment
# Tests ECMP, OPS, and REPS under mixed congestion patterns
# Metrics: Flow Completion Time (FCT) and Queue Length Variance

# Parameters Setting
EXECUTABLE="../../../build/datacenter/htsim_uec"
TOPOLOGY="../../topologies/topo_assignment2/fat_tree_128_4os.topo"
CONNECTION_MATRIX="congestion_scenario.cm"

# Output directory
OUTPUT_DIR="results"
mkdir -p "$OUTPUT_DIR"

echo "=========================================="
echo "Congestion Scenario Experiment"
echo "=========================================="
echo "Topology: $TOPOLOGY"
echo "Connection Matrix: $CONNECTION_MATRIX"
echo "Testing: ECMP, OPS (Oblivious), REPS"
echo "Metrics: FCT and Queue Length Variance"
echo ""

# Function to run simulation with queue logging
run_simulation() {
    local algo=$1
    local output_file="$OUTPUT_DIR/${algo}_congestion.out"
    local log_file="logout_${algo}.dat"
    local queue_log_file="queue_log_${algo}.dat"
    
    echo "Running simulation for: $algo"
    echo "----------------------------------------"
    
    $EXECUTABLE \
        -nodes 128 \
        -topo "$TOPOLOGY" \
        -tm "$CONNECTION_MATRIX" \
        -sender_cc_algo dctcp \
        -load_balancing_algo "$algo" \
        -queue_type composite_ecn \
        -q 100 \
        -ecn 20 80 \
        -paths 200 \
        -cwnd 10 \
        -mtu 1500 \
        -end 5000 \
        -log flow_events \
        -log switch \
        -logtime_us 10 \
        -seed 0 \
        > "$output_file" 2>&1
    
    if [ $? -eq 0 ]; then
        echo "✓ Simulation completed for $algo"
        
        # Move log files (logout.dat is generated by the simulation)
        if [ -f "logout.dat" ]; then
            cp "logout.dat" "${OUTPUT_DIR}/logout_${algo}.dat"
        fi
        if [ -f "$log_file" ]; then
            mv "$log_file" "${OUTPUT_DIR}/logout_${algo}.dat"
        fi
        if [ -f "$queue_log_file" ]; then
            mv "$queue_log_file" "${OUTPUT_DIR}/queue_log_${algo}.dat"
        fi
        
        echo "Results saved to: ${OUTPUT_DIR}/${algo}_congestion.out"
    else
        echo "✗ Simulation failed for $algo"
    fi
    echo ""
}

# Run simulations for all algorithms
run_simulation "ecmp"
run_simulation "oblivious"
run_simulation "reps"

echo "=========================================="
echo "All simulations completed!"
echo "=========================================="
echo ""
echo "Next steps:"
echo "  1. Extract FCT: ./extract_fct.sh"
echo "  2. Extract queue variance: ./extract_queue_variance.sh"
echo ""

